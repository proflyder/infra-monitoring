# ═══════════════════════════════════════════════════════════════════
# Grafana Datasources Configuration
# Автоматическое подключение источников данных при старте Grafana
# ═══════════════════════════════════════════════════════════════════

apiVersion: 1

# ───────────────────────────────────────────────────────────────────
# Удалить datasources которых нет в этом файле
# ───────────────────────────────────────────────────────────────────
deleteDatasources:
  - name: Loki
    orgId: 1

# ───────────────────────────────────────────────────────────────────
# Список datasources
# ───────────────────────────────────────────────────────────────────
datasources:
  # Loki - для просмотра логов
  - name: Loki
    type: loki
    access: proxy
    uid: loki
    url: http://loki:3100
    isDefault: true
    version: 1
    editable: false
    jsonData:
      maxLines: 1000
      derivedFields:
        # Автоматическое извлечение trace ID из логов (если используете tracing)
        - datasourceUid: loki
          matcherRegex: "traceID=(\\w+)"
          name: TraceID
          url: "$${__value.raw}"

# ═══════════════════════════════════════════════════════════════════
# Описание конфигурации:
# ═══════════════════════════════════════════════════════════════════
#
# АВТОМАТИЧЕСКОЕ ПОДКЛЮЧЕНИЕ:
# ───────────────────────────────────────────────────────────────────
# При запуске Grafana автоматически:
# 1. Подключает Loki как datasource
# 2. Устанавливает его по умолчанию
# 3. Настраивает URL: http://loki:3100
#
# КАК ИСПОЛЬЗОВАТЬ В GRAFANA:
# ───────────────────────────────────────────────────────────────────
# 1. Откройте Explore (иконка компаса в левом меню)
# 2. Выберите "Loki" в качестве datasource (уже выбран по умолчанию)
# 3. Используйте LogQL запросы:
#
#    ПРИМЕРЫ ЗАПРОСОВ:
#    {job="currency-bot"}                          # Все логи currency-bot
#    {job="currency-bot"} |= "ERROR"              # Только ошибки
#    {job="currency-bot"} |= "Quartz"             # Логи Quartz scheduler
#    {job="currency-bot"} | json                  # Парсить как JSON
#    {job="currency-bot"} | json | level="ERROR"  # JSON + фильтр по уровню
#    {job="currency-bot"} | json | message=~".*timeout.*"  # Поиск по regex
#
# ДОБАВЛЕНИЕ ДРУГИХ DATASOURCES:
# ───────────────────────────────────────────────────────────────────
# В будущем можно добавить:
# - Prometheus (для метрик)
# - Tempo (для distributed tracing)
# - PostgreSQL (для прямых запросов к БД)
#
# Пример Prometheus:
# - name: Prometheus
#   type: prometheus
#   access: proxy
#   url: http://prometheus:9090
#   isDefault: false
#
# ═══════════════════════════════════════════════════════════════════
