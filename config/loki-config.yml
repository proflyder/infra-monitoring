# ═══════════════════════════════════════════════════════════════════
# Loki Configuration
# Централизованное хранилище логов для всех проектов proflyder
# ═══════════════════════════════════════════════════════════════════

auth_enabled: false

server:
  http_listen_port: 3100
  grpc_listen_port: 9096
  log_level: info
  http_server_read_timeout: 5m
  http_server_write_timeout: 5m
  http_server_idle_timeout: 5m

# ───────────────────────────────────────────────────────────────────
# Ingester - компонент для приёма и буферизации логов
# ───────────────────────────────────────────────────────────────────
ingester:
  lifecycler:
    address: 127.0.0.1
    ring:
      kvstore:
        store: inmemory
      replication_factor: 1
    final_sleep: 0s

  # WAL (Write-Ahead Log) configuration
  wal:
    enabled: true
    dir: /loki/wal

  # Размер чанков (блоков логов)
  chunk_idle_period: 5m
  chunk_retain_period: 30s
  max_chunk_age: 1h

  # Лимиты для ресурсов
  max_transfer_retries: 0

# ───────────────────────────────────────────────────────────────────
# Schema Config - определяет как данные индексируются и хранятся
# ───────────────────────────────────────────────────────────────────
schema_config:
  configs:
    - from: 2023-01-01
      store: boltdb-shipper
      object_store: filesystem
      schema: v11
      index:
        prefix: index_
        period: 24h

# ───────────────────────────────────────────────────────────────────
# Storage Config - настройки хранилища
# ───────────────────────────────────────────────────────────────────
storage_config:
  boltdb_shipper:
    active_index_directory: /loki/boltdb-shipper-active
    cache_location: /loki/boltdb-shipper-cache
    cache_ttl: 24h
    shared_store: filesystem

  filesystem:
    directory: /loki/chunks

# ───────────────────────────────────────────────────────────────────
# Compactor - сжатие и очистка старых данных
# ───────────────────────────────────────────────────────────────────
compactor:
  working_directory: /loki/compactor
  shared_store: filesystem
  compaction_interval: 10m
  retention_enabled: true
  retention_delete_delay: 2h
  retention_delete_worker_count: 150

# ───────────────────────────────────────────────────────────────────
# Limits Config - лимиты для предотвращения перегрузки
# ───────────────────────────────────────────────────────────────────
limits_config:
  # Retention (срок хранения логов)
  retention_period: 336h  # 14 дней

  # Лимиты на запросы
  max_query_length: 337h  # Чуть больше retention_period
  max_query_lookback: 336h
  max_streams_per_user: 10000
  max_entries_limit_per_query: 50000  # Увеличено для запросов на 1d

  # Лимиты на входящие данные
  ingestion_rate_mb: 10  # 10 MB/s на stream
  ingestion_burst_size_mb: 20  # Burst до 20 MB
  per_stream_rate_limit: 3MB
  per_stream_rate_limit_burst: 15MB

  # Лимиты на размер одного лог-сообщения
  max_line_size: 256KB

  # Лимиты на query performance
  max_query_parallelism: 32  # Параллелизм внутри запроса (для больших интервалов)
  max_query_series: 10000  # Максимум серий в одном запросе
  query_timeout: 5m  # Таймаут на запрос (для длинных интервалов вроде 1d)

  # Разбиение длинных запросов на части
  split_queries_by_interval: 1h  # Увеличено с 15m для больших интервалов

# ───────────────────────────────────────────────────────────────────
# Chunk Store Config - настройки кеша
# ───────────────────────────────────────────────────────────────────
chunk_store_config:
  max_look_back_period: 336h  # Соответствует retention

# ───────────────────────────────────────────────────────────────────
# Table Manager - управление таблицами (deprecated, но нужен)
# ───────────────────────────────────────────────────────────────────
table_manager:
  retention_deletes_enabled: true
  retention_period: 336h

# ───────────────────────────────────────────────────────────────────
# Query Frontend - кеширование и оптимизация запросов
# ───────────────────────────────────────────────────────────────────
query_range:
  # Выравнивает запросы для лучшего кеширования
  align_queries_with_step: true

  # Увеличенный кеш для результатов
  results_cache:
    cache:
      embedded_cache:
        enabled: true
        max_size_mb: 256

  # Кеш для частичных результатов
  cache_results: true
  max_retries: 5

# ═══════════════════════════════════════════════════════════════════
# Описание конфигурации:
# ═══════════════════════════════════════════════════════════════════
#
# RETENTION (СРОК ХРАНЕНИЯ):
# ───────────────────────────────────────────────────────────────────
# - Логи хранятся 14 дней (336h)
# - Автоматическое удаление старых логов каждые 10 минут
# - Можно изменить retention_period на нужное значение
#
# ЛИМИТЫ:
# ───────────────────────────────────────────────────────────────────
# - Максимум 10 MB/s входящего потока логов
# - Максимум 10,000 streams на пользователя
# - Максимум 256 KB на одно лог-сообщение
# - До 10,000 строк на запрос (увеличено с 5000)
# - Параллелизм запросов: 32 потока
#
# ПРОИЗВОДИТЕЛЬНОСТЬ:
# ───────────────────────────────────────────────────────────────────
# - Кеширование запросов (100 MB)
# - Компактификация каждые 10 минут
# - Оптимизировано для небольших/средних проектов
#
# МОНИТОРИНГ LOKI:
# ───────────────────────────────────────────────────────────────────
# Метрики доступны на:
# http://localhost:3100/metrics (Prometheus format)
#
# Healthcheck endpoints:
# http://localhost:3100/ready
# http://localhost:3100/metrics
#
# ═══════════════════════════════════════════════════════════════════
