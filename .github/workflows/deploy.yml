name: Deploy Monitoring Stack

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ─────────────────────────────────────────────────────────────
      # Настройка SSH для подключения к VPS
      # ─────────────────────────────────────────────────────────────
      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          # Проверка обязательных секретов
          if [ -z "$SSH_PRIVATE_KEY" ]; then
            echo "❌ ERROR: SSH_PRIVATE_KEY secret is not set!"
            exit 1
          fi

          if [ -z "$SSH_HOST" ]; then
            echo "❌ ERROR: SSH_HOST secret is not set!"
            exit 1
          fi

          if [ -z "$SSH_USER" ]; then
            echo "❌ ERROR: SSH_USER secret is not set!"
            exit 1
          fi

          # Установка дефолтного порта если не указан
          if [ -z "$SSH_PORT" ]; then
            SSH_PORT=22
          fi

          echo "🔧 Setting up SSH connection..."

          # Создаём директорию для SSH
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh

          # Сохраняем приватный ключ
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key

          # Добавляем хост в known_hosts (отключаем проверку при первом подключении)
          ssh-keyscan -p ${SSH_PORT} -H "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true

          # Создаём SSH config для удобства
          cat > ~/.ssh/config <<EOF
          Host vps
            HostName $SSH_HOST
            User $SSH_USER
            Port ${SSH_PORT}
            IdentityFile ~/.ssh/deploy_key
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            LogLevel ERROR
          EOF

          chmod 600 ~/.ssh/config

          # Проверяем подключение
          echo "🔍 Testing SSH connection..."
          ssh vps "echo '✅ SSH connection successful!'"

      # ─────────────────────────────────────────────────────────────
      # Деплой мониторинга на VPS
      # ─────────────────────────────────────────────────────────────
      - name: Deploy monitoring stack
        env:
          GRAFANA_USER: ${{ secrets.GRAFANA_ADMIN_USER }}
          GRAFANA_PASSWORD: ${{ secrets.GRAFANA_ADMIN_PASSWORD }}
        run: |
          if [ -z "$GRAFANA_PASSWORD" ]; then
            echo "⚠️  WARNING: GRAFANA_ADMIN_PASSWORD is not set!"
            echo "Grafana will use default password 'admin'"
          fi

          echo "🚀 Deploying monitoring stack to VPS..."

          # Создаём временную директорию для файлов
          TEMP_DIR=$(mktemp -d)

          # Копируем все необходимые файлы
          cp -r docker-compose.yml config "$TEMP_DIR/"

          # Создаём .env файл с секретами
          cat > "$TEMP_DIR/.env" <<EOF
          GRAFANA_ADMIN_USER=${GRAFANA_USER:-admin}
          GRAFANA_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
          TZ=Asia/Almaty
          EOF

          # Создаём tar архив
          tar -czf monitoring-stack.tar.gz -C "$TEMP_DIR" .

          # Копируем архив на VPS
          echo "📦 Uploading files to VPS..."
          scp monitoring-stack.tar.gz vps:/tmp/

          # Выполняем команды на VPS
          echo "🔧 Setting up monitoring stack..."
          ssh vps bash <<'ENDSSH'
            set -e

            echo '📂 Creating monitoring directory...'
            sudo mkdir -p /opt/monitoring

            echo '📦 Extracting files...'
            sudo tar -xzf /tmp/monitoring-stack.tar.gz -C /opt/monitoring/
            sudo rm /tmp/monitoring-stack.tar.gz

            echo '🔒 Setting permissions...'
            sudo chown -R $USER:$USER /opt/monitoring
            sudo chmod 600 /opt/monitoring/.env

            echo '🐳 Stopping old containers...'
            cd /opt/monitoring
            sudo docker compose down 2>/dev/null || true

            echo '🐳 Starting monitoring stack...'
            sudo docker compose up -d

            echo '⏳ Waiting for services to start...'
            sleep 15

            echo '✅ Deployment completed!'
          ENDSSH

          # Очистка
          rm -rf "$TEMP_DIR" monitoring-stack.tar.gz

          echo "✅ Successfully deployed monitoring stack!"

      # ─────────────────────────────────────────────────────────────
      # Проверка здоровья после деплоя
      # ─────────────────────────────────────────────────────────────
      - name: Health check
        run: |
          echo "🔍 Running health checks..."

          ssh vps bash <<'ENDSSH'
            echo '📊 Container status:'
            sudo docker compose -f /opt/monitoring/docker-compose.yml ps

            echo ''
            echo '💾 Volume usage:'
            sudo docker volume ls | grep monitoring || echo 'No monitoring volumes found yet'

            echo ''
            echo '🌐 Loki health:'
            curl -s http://localhost:3100/ready && echo '✅ Loki is ready' || echo '❌ Loki is not ready'

            echo ''
            echo '📈 Grafana health:'
            curl -s http://localhost:3000/api/health | grep -q 'ok' && echo '✅ Grafana is ready' || echo '❌ Grafana is not ready'

            echo ''
            echo '🖥️  Node Exporter health:'
            curl -s http://localhost:9100/metrics > /dev/null && echo '✅ Node Exporter is ready' || echo '❌ Node Exporter is not ready'

            echo ''
            echo '📊 Prometheus health:'
            curl -s http://localhost:9090/-/healthy > /dev/null && echo '✅ Prometheus is ready' || echo '❌ Prometheus is not ready'
          ENDSSH

      # ─────────────────────────────────────────────────────────────
      # Вывод информации о доступе
      # ─────────────────────────────────────────────────────────────
      - name: Display access info
        run: |
          echo ""
          echo "═══════════════════════════════════════════════════════"
          echo "✅ Monitoring Stack Deployed Successfully!"
          echo "═══════════════════════════════════════════════════════"
          echo ""
          echo "📊 Grafana URL: https://proflyder.dev/grafana/"
          echo "👤 Username: admin (or from GRAFANA_ADMIN_USER)"
          echo "🔑 Password: (from GRAFANA_ADMIN_PASSWORD secret)"
          echo ""
          echo "📝 Next steps:"
          echo "1. Configure nginx for Grafana (see config/nginx-grafana.conf)"
          echo "2. Setup SSL certificate with certbot"
          echo "3. Reload nginx: sudo systemctl reload nginx"
          echo "4. Open https://proflyder.dev/grafana/ in browser"
          echo ""
          echo "═══════════════════════════════════════════════════════"

# ═══════════════════════════════════════════════════════════════════
# Требуемые GitHub Secrets:
# ═══════════════════════════════════════════════════════════════════
#
# SSH_PRIVATE_KEY            - Приватный SSH ключ для доступа к VPS
# SSH_HOST                   - IP адрес или домен VPS сервера
# SSH_USER                   - Пользователь для SSH подключения (обычно: deploy)
# SSH_PORT                   - Порт SSH (опционально, по умолчанию: 22)
# GRAFANA_ADMIN_USER         - Username для Grafana (опционально, по умолчанию: admin)
# GRAFANA_ADMIN_PASSWORD     - Пароль для Grafana admin пользователя
#
# ═══════════════════════════════════════════════════════════════════
# Как работает деплой:
# ═══════════════════════════════════════════════════════════════════
#
# 1. Checkout кода из репозитория
# 2. Настройка SSH подключения к VPS
# 3. Создание tar архива с конфигами и .env
# 4. Копирование архива на VPS через SCP
# 5. SSH на VPS и выполнение команд:
#    - Создание директории /opt/monitoring
#    - Распаковка архива
#    - docker compose down (остановка старых контейнеров)
#    - docker compose up -d (запуск новых контейнеров)
# 6. Health check всех сервисов
# 7. Вывод информации о доступе
#
# ═══════════════════════════════════════════════════════════════════
