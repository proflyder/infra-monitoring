name: Deploy Monitoring Stack

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to GCP VM
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ÐÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ Ð² Google Cloud
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCC_TOKEN }}

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° gcloud CLI
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Ð”ÐµÐ¿Ð»Ð¾Ð¹ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° Ð½Ð° VM
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Deploy monitoring stack
        env:
          VM_NAME: ${{ secrets.GCC_VM_NAME }}
          VM_ZONE: ${{ secrets.GCC_VM_ZONE }}
          GRAFANA_USER: ${{ secrets.GRAFANA_ADMIN_USER }}
          GRAFANA_PASSWORD: ${{ secrets.GRAFANA_ADMIN_PASSWORD }}
        run: |
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… ÑÐµÐºÑ€ÐµÑ‚Ð¾Ð²
          if [ -z "$VM_NAME" ]; then
            echo "âŒ ERROR: GCC_VM_NAME secret is not set!"
            exit 1
          fi

          if [ -z "$VM_ZONE" ]; then
            echo "âŒ ERROR: GCC_VM_ZONE secret is not set!"
            exit 1
          fi

          if [ -z "$GRAFANA_PASSWORD" ]; then
            echo "âš ï¸  WARNING: GRAFANA_ADMIN_PASSWORD is not set!"
            echo "Grafana will use default password 'admin'"
          fi

          echo "ðŸš€ Deploying monitoring stack to VM: $VM_NAME in zone $VM_ZONE"

          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð´Ð»Ñ Ñ„Ð°Ð¹Ð»Ð¾Ð²
          TEMP_DIR=$(mktemp -d)

          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÑÐµ Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
          cp -r docker-compose.yml config .env.example "$TEMP_DIR/"

          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ .env Ñ„Ð°Ð¹Ð» Ñ ÑÐµÐºÑ€ÐµÑ‚Ð°Ð¼Ð¸
          cat > "$TEMP_DIR/.env" <<EOF
          GRAFANA_ADMIN_USER=${GRAFANA_USER}
          GRAFANA_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
          EOF

          # Ð¡Ð¾Ð·Ð´Ð°Ñ‘Ð¼ tar Ð°Ñ€Ñ…Ð¸Ð²
          tar -czf monitoring-stack.tar.gz -C "$TEMP_DIR" .

          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð°Ñ€Ñ…Ð¸Ð² Ð½Ð° VM
          echo "ðŸ“¦ Uploading files to VM..."
          gcloud compute scp monitoring-stack.tar.gz "$VM_NAME:/tmp/" \
            --zone="$VM_ZONE"

          # Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð½Ð° VM
          echo "ðŸ”§ Setting up monitoring stack..."
          gcloud compute ssh "$VM_NAME" \
            --zone="$VM_ZONE" \
            --command="
              set -e

              echo 'ðŸ“‚ Creating monitoring directory...'
              sudo mkdir -p /opt/monitoring

              echo 'ðŸ“¦ Extracting files...'
              sudo tar -xzf /tmp/monitoring-stack.tar.gz -C /opt/monitoring/
              sudo rm /tmp/monitoring-stack.tar.gz

              echo 'ðŸ”’ Setting permissions...'
              sudo chown -R root:root /opt/monitoring
              sudo chmod 600 /opt/monitoring/.env

              echo 'ðŸ³ Starting monitoring stack...'
              sudo sh -c 'cd /opt/monitoring && docker compose down' || true
              sudo sh -c 'cd /opt/monitoring && docker compose up -d'

              echo 'â³ Waiting for services to start...'
              sleep 15

              echo 'âœ… Deployment completed!'
            "

          # ÐžÑ‡Ð¸ÑÑ‚ÐºÐ°
          rm -rf "$TEMP_DIR" monitoring-stack.tar.gz

          echo "âœ… Successfully deployed monitoring stack to $VM_NAME"

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð·Ð´Ð¾Ñ€Ð¾Ð²ÑŒÑ Ð¿Ð¾ÑÐ»Ðµ Ð´ÐµÐ¿Ð»Ð¾Ñ
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Health check
        env:
          VM_NAME: ${{ secrets.GCC_VM_NAME }}
          VM_ZONE: ${{ secrets.GCC_VM_ZONE }}
        run: |
          echo "ðŸ” Running health checks..."

          gcloud compute ssh "$VM_NAME" \
            --zone="$VM_ZONE" \
            --command="
              echo 'ðŸ“Š Container status:'
              sudo sh -c 'cd /opt/monitoring && docker compose ps'

              echo ''
              echo 'ðŸ’¾ Volume usage:'
              sudo docker volume ls | grep monitoring

              echo ''
              echo 'ðŸŒ Loki health:'
              curl -s http://localhost:3100/ready && echo 'âœ… Loki is ready' || echo 'âŒ Loki is not ready'

              echo ''
              echo 'ðŸ“ˆ Grafana health:'
              curl -s http://localhost:3000/api/health | grep -q 'ok' && echo 'âœ… Grafana is ready' || echo 'âŒ Grafana is not ready'
            "

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      # Ð’Ñ‹Ð²Ð¾Ð´ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ðµ
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: Display access info
        run: |
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… Monitoring Stack Deployed Successfully!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ðŸ“Š Grafana URL: https://proflyder.dev/grafana/"
          echo "ðŸ‘¤ Username: admin"
          echo "ðŸ”‘ Password: (from GRAFANA_ADMIN_PASSWORD secret)"
          echo ""
          echo "ðŸ“ Next steps:"
          echo "1. Add nginx config from config/nginx-grafana.conf"
          echo "2. Reload nginx: sudo systemctl reload nginx"
          echo "3. Open https://proflyder.dev/grafana/ in browser"
          echo ""
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Ð¢Ñ€ÐµÐ±ÑƒÐµÐ¼Ñ‹Ðµ GitHub Secrets:
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# GCC_TOKEN                  - Google Cloud credentials JSON
# GCC_VM_NAME                - Ð˜Ð¼Ñ VM Ð² GCP (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: proflyder-vm)
# GCC_VM_ZONE                - Ð—Ð¾Ð½Ð° VM (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: us-central1-a)
# GRAFANA_ADMIN_USER         - Username Ð´Ð»Ñ Grafana (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾, Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ: admin)
# GRAFANA_ADMIN_PASSWORD     - ÐŸÐ°Ñ€Ð¾Ð»ÑŒ Ð´Ð»Ñ Grafana admin Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ÐšÐ°Ðº Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð´ÐµÐ¿Ð»Ð¾Ð¹:
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# 1. Checkout ÐºÐ¾Ð´Ð° Ð¸Ð· Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
# 2. ÐÑƒÑ‚ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ñ Ð² Google Cloud
# 3. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ tar Ð°Ñ€Ñ…Ð¸Ð²Ð° Ñ ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð°Ð¼Ð¸
# 4. ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð°Ñ€Ñ…Ð¸Ð²Ð° Ð½Ð° VM Ñ‡ÐµÑ€ÐµÐ· gcloud compute scp
# 5. SSH Ð½Ð° VM Ð¸ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´:
#    - Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ /opt/monitoring
#    - Ð Ð°ÑÐ¿Ð°ÐºÐ¾Ð²ÐºÐ° Ð°Ñ€Ñ…Ð¸Ð²Ð°
#    - docker compose up -d
# 6. Health check
# 7. Ð’Ñ‹Ð²Ð¾Ð´ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ðµ
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
