name: Deploy Monitoring Stack

on:
  push:
    branches: [ master ]
  workflow_dispatch:

# Предотвращаем параллельные деплои
concurrency:
  group: production-deployment
  cancel-in-progress: false  # Ждем завершения текущего деплоя, не отменяем

jobs:
  # ═══════════════════════════════════════════════════════════════════
  # Build and push config image to GHCR
  # ═══════════════════════════════════════════════════════════════════
  build:
    name: Build Config Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}-config
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      - name: Build and push config image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ═══════════════════════════════════════════════════════════════════
  # Deploy to VPS
  # ═══════════════════════════════════════════════════════════════════
  deploy:
    name: Deploy to VPS
    needs: build
    uses: proflyder/infra-ci/.github/workflows/deploy-reusable.yml@master
    with:
      deploy_path: /opt/monitoring
      docker_image: ghcr.io/${{ github.repository }}-config:latest
      cleanup_image_pattern: infra-monitoring
      commit_sha: ${{ github.sha }}
      commit_message: ${{ github.event.head_commit.message }}
      wait_time: '30'
    secrets:
      ssh_host: ${{ secrets.SSH_HOST }}
      ssh_user: ${{ secrets.SSH_USER }}
      ssh_key: ${{ secrets.SSH_PRIVATE_KEY }}
      ssh_port: ${{ secrets.SSH_PORT }}
      env_content: |
        GRAFANA_ADMIN_USER=${{ secrets.GRAFANA_ADMIN_USER || 'admin' }}
        GRAFANA_ADMIN_PASSWORD=${{ secrets.GRAFANA_ADMIN_PASSWORD }}
        TZ=Asia/Almaty
      grafana_api_key: ${{ secrets.GRAFANA_API_KEY }}

  # ═══════════════════════════════════════════════════════════════════
  # Rollback при ошибке деплоя
  # ═══════════════════════════════════════════════════════════════════
  rollback:
    name: Rollback on Failure
    needs: deploy
    if: failure()
    uses: proflyder/infra-ci/.github/workflows/rollback-reusable.yml@master
    with:
      deploy_path: /opt/monitoring
      commit_sha: ${{ github.sha }}
      wait_time: '20'
    secrets:
      ssh_host: ${{ secrets.SSH_HOST }}
      ssh_user: ${{ secrets.SSH_USER }}
      ssh_key: ${{ secrets.SSH_PRIVATE_KEY }}
      ssh_port: ${{ secrets.SSH_PORT }}
      env_content: |
        GRAFANA_ADMIN_USER=${{ secrets.GRAFANA_ADMIN_USER || 'admin' }}
        GRAFANA_ADMIN_PASSWORD=${{ secrets.GRAFANA_ADMIN_PASSWORD }}
        TZ=Asia/Almaty
      grafana_api_key: ${{ secrets.GRAFANA_API_KEY }}
