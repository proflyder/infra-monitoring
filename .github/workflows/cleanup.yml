name: Cleanup Old Docker Images

on:
  schedule:
    # ĞšĞ°Ğ¶Ğ´Ğ¾Ğµ Ğ²Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒĞµ Ğ² 00:00 UTC (06:00 Almaty)
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  cleanup:
    name: Cleanup VPS
    runs-on: ubuntu-latest

    steps:
      - name: Cleanup old Docker images on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 5m
          script: |
            echo 'ğŸ§¹ Starting cleanup...'
            echo ''

            echo 'ğŸ“¦ Current images:'
            sudo docker images
            echo ''

            echo 'ğŸ—‘ï¸  Removing unused images older than 30 days...'
            sudo docker image prune -a --filter "until=720h" --force
            echo ''

            echo 'ğŸ—‘ï¸  Removing unused volumes...'
            sudo docker volume prune --force
            echo ''

            echo 'ğŸ—‘ï¸  Removing unused networks...'
            sudo docker network prune --force
            echo ''

            echo 'ğŸ“Š Final state:'
            sudo docker images
            sudo docker ps -a
            echo ''

            echo 'âœ… Cleanup completed!'
