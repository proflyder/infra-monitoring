services:
  # ═══════════════════════════════════════════════════════════════════
  # Loki - централизованное хранилище логов
  # ═══════════════════════════════════════════════════════════════════
  loki:
    image: grafana/loki:3.3.2
    container_name: loki
    ports:
      - "0.0.0.0:3100:3100"  # Доступен для Promtail из других Docker сетей
    volumes:
      - ./config/loki-config.yml:/etc/loki/local-config.yaml
      - loki-data:/loki
    command: -config.file=/etc/loki/local-config.yaml
    networks:
      - monitoring
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3100/ready 2>&1 || exit 1"]
      interval: 5s
      timeout: 10s
      retries: 5
      start_period: 30s

  # ═══════════════════════════════════════════════════════════════════
  # Node Exporter - системные метрики VM (CPU, Memory, Disk, Network)
  # ═══════════════════════════════════════════════════════════════════
  node-exporter:
    image: prom/node-exporter:v1.10.2
    container_name: node-exporter
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--path.rootfs=/rootfs'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    ports:
      - "127.0.0.1:9100:9100"
    networks:
      - monitoring
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9100/metrics 2>&1 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ═══════════════════════════════════════════════════════════════════
  # Prometheus - сбор и хранение метрик
  # ═══════════════════════════════════════════════════════════════════
  prometheus:
    image: prom/prometheus:v3.8.0
    container_name: prometheus
    ports:
      - "127.0.0.1:9090:9090"  # Доступ только локально
    volumes:
      - ./config/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    networks:
      - monitoring
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:9090/-/healthy 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  # ═══════════════════════════════════════════════════════════════════
  # Grafana - визуализация логов и метрик
  # Доступ: https://proflyder.dev/grafana/
  # ═══════════════════════════════════════════════════════════════════
  grafana:
    image: grafana/grafana:12.1
    container_name: grafana
    ports:
      - "127.0.0.1:3000:3000"  # Доступ только через nginx
    environment:
      # ─────────────────────────────────────────────────────────────
      # Безопасность
      # ─────────────────────────────────────────────────────────────
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_AUTH_ANONYMOUS_ENABLED=false

      # ─────────────────────────────────────────────────────────────
      # Настройка для работы через nginx на /grafana/
      # ─────────────────────────────────────────────────────────────
      - GF_SERVER_ROOT_URL=https://proflyder.dev/grafana/
      - GF_SERVER_SERVE_FROM_SUB_PATH=true

      # ─────────────────────────────────────────────────────────────
      # Дополнительные настройки
      # ─────────────────────────────────────────────────────────────
      - GF_INSTALL_PLUGINS=
      - GF_LOG_MODE=console
      - GF_LOG_LEVEL=info

    volumes:
      - grafana-data:/var/lib/grafana
      # Автоматическое подключение Loki как datasource
      - ./config/grafana-datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml
      # Автоматическое создание дашбордов
      - ./config/grafana-dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yml
      - ./config/grafana-dashboard-logs.json:/etc/grafana/provisioning/dashboards/logs.json
      - ./config/grafana-dashboard-system.json:/etc/grafana/provisioning/dashboards/system.json
      - ./config/grafana-dashboard-currency.json:/etc/grafana/provisioning/dashboards/currency.json
      - ./config/grafana-dashboard-api.json:/etc/grafana/provisioning/dashboards/api.json
    networks:
      - monitoring
    restart: unless-stopped
    depends_on:
      loki:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:3000/api/health 2>&1 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 20s

# ═══════════════════════════════════════════════════════════════════
# Networks - изолированная сеть для мониторинга
# ═══════════════════════════════════════════════════════════════════
networks:
  monitoring:
    driver: bridge

# ═══════════════════════════════════════════════════════════════════
# Volumes - персистентное хранение данных
# ═══════════════════════════════════════════════════════════════════
volumes:
  loki-data:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local

# ═══════════════════════════════════════════════════════════════════
# Как использовать:
# ═══════════════════════════════════════════════════════════════════
#
# ПЕРВЫЙ ЗАПУСК:
# ───────────────────────────────────────────────────────────────────
# 1. Скопировать .env.example в .env
# 2. Установить GRAFANA_ADMIN_PASSWORD в .env
# 3. docker compose up -d
# 4. Добавить конфиг в nginx (см. config/nginx-grafana.conf)
# 5. Перезагрузить nginx: sudo systemctl reload nginx
#
# ДОСТУП:
# ───────────────────────────────────────────────────────────────────
# URL: https://proflyder.dev/grafana/
# Логин: admin (или из GRAFANA_ADMIN_USER)
# Пароль: из .env (GRAFANA_ADMIN_PASSWORD)
#
# УПРАВЛЕНИЕ:
# ───────────────────────────────────────────────────────────────────
# docker compose up -d              # Запустить
# docker compose down               # Остановить
# docker compose logs -f            # Просмотр логов
# docker compose restart grafana    # Перезапустить Grafana
# docker compose ps                 # Статус контейнеров
#
# ПРОВЕРКА ЗДОРОВЬЯ:
# ───────────────────────────────────────────────────────────────────
# curl http://localhost:3100/ready    # Loki
# curl http://localhost:3000/api/health  # Grafana
#
# ПОДКЛЮЧЕНИЕ ПРОЕКТОВ:
# ───────────────────────────────────────────────────────────────────
# Каждый проект должен запускать свой Promtail контейнер,
# который отправляет логи в Loki (localhost:3100).
#
# Пример конфига Promtail:
# clients:
#   - url: http://host.docker.internal:3100/loki/api/v1/push
#
# В Grafana логи фильтруются по label 'job':
# {job="currency-bot"}      # Логи currency-bot
# {job="another-project"}   # Логи другого проекта
#
# BACKUP:
# ───────────────────────────────────────────────────────────────────
# docker run --rm \
#   -v infra-monitoring_loki-data:/source \
#   -v $(pwd)/backups:/backup \
#   alpine tar czf /backup/loki-backup-$(date +%Y%m%d).tar.gz -C /source .
#
# docker run --rm \
#   -v infra-monitoring_grafana-data:/source \
#   -v $(pwd)/backups:/backup \
#   alpine tar czf /backup/grafana-backup-$(date +%Y%m%d).tar.gz -C /source .
#
# ОЧИСТКА СТАРЫХ ДАННЫХ:
# ───────────────────────────────────────────────────────────────────
# Loki автоматически удаляет старые логи согласно retention_period
# в config/loki-config.yml (по умолчанию 14 дней)
#
# ═══════════════════════════════════════════════════════════════════
